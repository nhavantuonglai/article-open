<script client:load>

	document.addEventListener('DOMContentLoaded', () => {
		const chatInput = document.getElementById('integrate-input');
		const resultOutput = document.getElementById('integrate-text-output');
		const apiKey = import.meta.env.PUBLIC_GEMINI_API_KEY;
		let debounceTimeout;

		chatInput.addEventListener('input', () => {
			const question = chatInput.value.trim();
			clearTimeout(debounceTimeout);

			if (!question) {
				resultOutput.textContent = 'Vui lòng nhập câu hỏi.';
				return;
			}

			debounceTimeout = setTimeout(async () => {
				resultOutput.textContent = 'Đang xử lý câu trả lời…';

				try {
					const response = await fetch(
						`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`,
						{
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({
								contents: [
									{
										parts: [
											{ text: question }
										]
									}
								]
							})
						}
					);

					if (!response.ok) {
						const error = await response.text();
						try {
							const errorJSON = JSON.parse(error);
							if (errorJSON.error && errorJSON.error.message) {
								resultOutput.textContent = `Lỗi: ${errorJSON.error.message}`;
							} else {
								resultOutput.textContent = 'Lỗi kết nối với API Gemini.';
							}
						} catch (parseError) {
							resultOutput.textContent = 'Lỗi xử lý phản hồi từ server.';
							console.error("Parse error:", parseError);
						}
						return;
					}

					const result = await response.json();
					const aiResponse = result.candidates[0].content;

					function formatResponse(text) {
						text = text.replace(/—|-/g, '–');
						text = text.replace(/\.{3}/g, '…');
						text = text.replace(/[*"]/g, '');
						return text;
					}

					if (aiResponse?.parts?.[0]?.text) {
						const formattedResponse = formatResponse(aiResponse.parts[0].text);
						resultOutput.innerHTML = `
							<div class="chat-response">
								<div class="response-content">
									${formattedResponse}
								</div>
							</div>
						`;
					} else {
						resultOutput.textContent = 'Không nhận được phản hồi hợp lệ từ AI.';
						console.error("Unexpected response format:", aiResponse);
					}
				} catch (error) {
					console.error('Error:', error);
					resultOutput.textContent = 'Có lỗi xảy ra khi xử lý yêu cầu.';
				}
			}, 500);
		});
	});

</script>