---
import Button from '~/components/ui/button.astro';
import CTA from '~/components/widgets/services.astro';
---

<section class="relative md:-mt-[76px] not-prose">

	<div class="absolute inset-0 pointer-events-none" aria-hidden="true"></div>
	<div class="pt-0 md:pt-[120px] pointer-events-none"></div>
	<h1 class="mx-auto max-w-7xl md:px-6 leading-tighter text-center text-4xl md:text-5xl font-bold leading-tighter tracking-tighter mb-6 font-heading">
		Trợ lý AI Google tích hợp Gemini API
	</h1>

	<div class="mx-auto max-w-7xl md:px-6 px-4">

		<textarea id="input" placeholder="Nhập câu hỏi của bạn…" class="px-4 mb-6 py-6 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900" required></textarea>

		<button id="convert-btn" class="btn-primary w-auto mb-6">Gửi yêu cầu</button>

		<div id="output" class="mb-6 text-lg border border-gray-300 p-4 rounded-lg"></div>

	</div>

	<script client:load>
		document.addEventListener("DOMContentLoaded", function () {
			const buttonConvert = document.getElementById('convert-btn');
			const input = document.getElementById('input');
			const output = document.getElementById('output');

			buttonConvert.addEventListener('click', async function () {
				const inputText = input.value.trim();
				if (!inputText) {
					output.innerText = "Lỗi nhập liệu, không tìm thấy dữ liệu đầu vào, vui lòng kiểm tra lại.";
					return;
				}

				const apiKey = "AIzaSyDdLtr1xSz2DRc9BlXVpcHgoXhMvHlEHPo";

				const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;

				output.innerText = "Đang xử lý…";

				try {
					const response = await fetch(endpoint, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							contents: [
								{
									parts: [
										{ text: inputText }
									]
								}
							]
						})
					});

					if (!response.ok) {
						const error = await response.text();
						try {
							const errorJSON = JSON.parse(error);
							if (errorJSON.error && errorJSON.error.message) {
								output.innerText = `Lỗi máy chủ xác định được nguyên nhân: ${errorJSON.error.message}, vui lòng thử lại sau và báo cáo với quản trị viên.`;
							} else {
								output.innerText = `Lỗi máy chủ liên quan đến thư viện Google Cloud Platform, vui lòng thử lại sau và báo cáo với quản trị viên.`;
							}
						} catch (parseError) {
							output.innerText = `Lỗi nhập liệu, định dạng dữ liệu không hợp lệ, vui lòng kiểm tra lại.`;
							console.error("Could not parse error response as JSON:", parseError);
						}
						console.error('Error response:', response.status, error);
						return;
					}

					const result = await response.json();
					const aiResponse = result.candidates[0].content;

					function formatText(text) {
						text = text.replace(/—|-/g, '–');
						text = text.replace(/\.{3}/g, '…');
						text = text.replace(/[*"]/g, '');
						return text;
					}

					if (typeof aiResponse === 'object' && aiResponse !== null && aiResponse.parts && Array.isArray(aiResponse.parts) && aiResponse.parts.length > 0 && aiResponse.parts[0].text) {
						output.innerText = formatText(aiResponse.parts[0].text);
					} else if (typeof aiResponse === 'string') {
						output.innerText = formatText(aiResponse);
					} else {
						output.innerText = "Lỗi máy chủ liên quan đến hệ thống Google AI, vui lòng thử lại sau và báo cáo với quản trị viên.";
						console.error("Unexpected response format:", aiResponse);
					}

				} catch (error) {
					console.error('Error:', error);
					output.innerText = 'Lỗi máy chủ không thể kết nối, vui lòng thử lại sau và báo cáo với quản trị viên.';
				}
			});
		});
	</script>
	
</section>
