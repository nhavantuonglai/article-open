---
import Button from '~/components/ui/button.astro';
import CTA from '~/components/widgets/services.astro';
---

<section class="relative md:-mt-[76px] not-prose">
  <div class="absolute inset-0 pointer-events-none" aria-hidden="true"></div>
  <div class="pt-0 md:pt-[120px] pointer-events-none"></div>
  <h1 class="mx-auto max-w-7xl md:px-6 leading-tighter text-center text-4xl md:text-5xl font-bold leading-tighter tracking-tighter mb-6 font-heading">
    dieuphapam
  </h1>

  <div class="mx-auto max-w-7xl md:px-6 px-4">
    <textarea id="input" placeholder="Nhập URL trang chứa các liên kết tải…" class="px-4 mb-6 py-6 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900" required></textarea>

    <button id="convert-btn" class="btn-primary w-auto mb-6">Gửi yêu cầu</button>

    <div id="output" class="mb-6 text-lg border border-gray-300 p-4 rounded-lg"></div>
  </div>

	<script client:load>
		document.addEventListener("DOMContentLoaded", function () {
			const buttonConvert = document.getElementById('convert-btn');
			const input = document.getElementById('input');
			const output = document.getElementById('output');

			buttonConvert.addEventListener('click', async function () {
				const inputURL = input.value.trim();
				output.innerHTML = "Đang xử lý…"; // Set initial message


				try {
					const match = inputURL.match(/\.(\d+)\/?$/);
					if (!match) {
						output.innerHTML = "Định dạng URL đầu vào không hợp lệ.";
						return;
					}
					const number = match[1];
					const newURL = `https://media.dieuphapam.net/portal/download.php?f=${number}.dieuphapam.list`;


					const response = await fetch(newURL, {
						mode: 'no-cors',
						credentials: 'include',
						redirect: 'follow'
					});



					if (!response.ok) {
						if (response.status === 403) {
							output.innerHTML = "Lỗi 403: Không có quyền truy cập.";
						} else {
                            output.innerHTML = "Lỗi từ máy chủ."
							console.error('Error response:', response.status, await response.text()); // Log for debugging
                        }
						return;
					}

					const text = await response.text();
					const urlRegex = /(https?:\/\/[^\s]+)/g;
					const urls = text.match(urlRegex) || [];


					if (urls.length === 0) {
						output.innerHTML = "Không tìm thấy liên kết nào.";
					} else {
						let outputHTML = "";
						urls.forEach(url => {
							outputHTML += `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a><br>`;
						});
						output.innerHTML = outputHTML;
					}

				} catch (error) {
					console.error("Lỗi không xác định:", error);
					if (error.message === "Failed to fetch") {
						output.innerHTML = "Lỗi mạng: Không thể kết nối đến máy chủ.";
					} else {
						output.innerHTML = "Lỗi không xác định. Vui lòng kiểm tra console để biết thêm chi tiết.";
					}
				}
			});
		});
	</script>







</section>