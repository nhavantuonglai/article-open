---
import Button from '~/components/ui/button.astro';
import CTA from '~/components/widgets/services.astro';
---

<section class="relative md:-mt-[76px] not-prose">
  <div class="absolute inset-0 pointer-events-none" aria-hidden="true"></div>
  <div class="pt-0 md:pt-[120px] pointer-events-none"></div>
  <h1 class="mx-auto max-w-7xl md:px-6 leading-tighter text-center text-4xl md:text-5xl font-bold leading-tighter tracking-tighter mb-6 font-heading">
    dieuphapam
  </h1>

  <div class="mx-auto max-w-7xl md:px-6 px-4">
    <textarea id="input" placeholder="Nhập URL trang chứa các liên kết tải…" class="px-4 mb-6 py-6 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900" required></textarea>

    <button id="convert-btn" class="btn-primary w-auto mb-6">Gửi yêu cầu</button>

    <div id="output" class="mb-6 text-lg border border-gray-300 p-4 rounded-lg"></div>
  </div>

<script client:load>
  async function getNewUrl(inputUrl) {
    try {
      // Tìm phần số ở cuối URL
      const regex = /(\d+)\/?$/;
      const match = inputUrl.match(regex);
      
      if (!match) {
        throw new Error("Không tìm thấy dãy số trong URL");
      }

      const number = match[1];
      const newUrl = `https://media.dieuphapam.net/portal/download.php?f=${number}.dieuphapam.list`;
      
      // Kiểm tra URL mới bằng fetch để tránh lỗi 403 hay Failed to fetch
      const response = await fetch(newUrl, {
        method: 'GET',
        headers: {
          'User-Agent': 'Mozilla/5.0',  // Thêm User-Agent để tránh bị chặn
          'Accept': 'application/json',
        },
        // Đặt thời gian chờ kết nối (timeout)
      });

      if (!response.ok) {
        if (response.status === 403) {
          throw new Error("Lỗi 403: Truy cập bị từ chối.");
        } else if (response.status === 404) {
          throw new Error("Lỗi 404: Không tìm thấy trang.");
        } else {
          throw new Error(`Lỗi HTTP: ${response.status}`);
        }
      }

      return newUrl; // Trả về URL mới nếu thành công

    } catch (error) {
      console.error("Lỗi xảy ra:", error);

      // Kiểm tra lỗi liên quan đến mạng hoặc kết nối
      if (error.message === "Failed to fetch") {
        return "Lỗi mạng: Không thể kết nối đến máy chủ. Vui lòng thử lại sau.";
      }

      return `Lỗi: ${error.message}`;
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    const buttonConvert = document.getElementById('convert-btn');
    const inputField = document.getElementById('input');
    const output = document.getElementById('output');

    buttonConvert.addEventListener('click', async function () {
      const input = inputField.value.trim();
      output.innerHTML = "Đang xử lý…";

      // Gọi hàm để xử lý URL và nhận kết quả
      const newURL = await getNewUrl(input);

      // Hiển thị kết quả hoặc thông báo lỗi
      output.innerHTML = newURL;
    });
  });
</script>
</section>
