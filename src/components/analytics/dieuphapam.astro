---
import Button from '~/components/ui/button.astro';
import CTA from '~/components/widgets/services.astro';
---

<section class="relative md:-mt-[76px] not-prose">
  <div class="absolute inset-0 pointer-events-none" aria-hidden="true"></div>
  <div class="pt-0 md:pt-[120px] pointer-events-none"></div>
  <h1 class="mx-auto max-w-7xl md:px-6 leading-tighter text-center text-4xl md:text-5xl font-bold leading-tighter tracking-tighter mb-6 font-heading">
    dieuphapam
  </h1>

  <div class="mx-auto max-w-7xl md:px-6 px-4">
    <textarea id="input" placeholder="Nhập URL trang chứa các liên kết tải…" class="px-4 mb-6 py-6 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900" required></textarea>

    <button id="convert-btn" class="btn-primary w-auto mb-6">Gửi yêu cầu</button>

    <div id="output" class="mb-6 text-lg border border-gray-300 p-4 rounded-lg"></div>
  </div>

<script client:load>
  document.getElementById('convert-btn').addEventListener('click', async () => {
    const url = document.getElementById('input').value.trim();
    const outputElement = document.getElementById('output');

    // Clear previous output
    outputElement.innerHTML = 'Đang xử lý...';

    // Kiểm tra URL hợp lệ
    if (!url || !url.startsWith('http')) {
      outputElement.innerHTML = 'Vui lòng nhập URL hợp lệ!';
      return;
    }

    try {
      // Lấy dãy số cuối cùng từ URL đầu vào
      const match = url.match(/\.([0-9]+)\/?$/);
      if (!match) {
        outputElement.innerHTML = 'Không tìm thấy dãy số hợp lệ trong URL!';
        return;
      }

      const fileId = match[1];
      const downloadListUrl = `https://media.dieuphapam.net/portal/download.php?f=${fileId}.dieuphapam.list`;

      // Fetch nội dung từ URL mới
      const proxyUrl = 'https://cors-anywhere.herokuapp.com/'; // Sử dụng proxy nếu cần
      const fetchUrl = proxyUrl + downloadListUrl;

      const response = await fetch(fetchUrl, {
        method: 'GET',
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36',
          'Accept': 'text/html',
        },
      });

      if (!response.ok) {
        throw new Error(`Lỗi HTTP: ${response.status} - ${response.statusText}`);
      }

      const htmlContent = await response.text();

      // Tìm tất cả các link tải xuống từ nội dung trả về
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlContent, 'text/html');
      const links = Array.from(doc.querySelectorAll('a[href]')).map((a) => a.href);

      if (links.length === 0) {
        outputElement.innerHTML = 'Không tìm thấy liên kết tải nào.';
        return;
      }

      // Hiển thị danh sách liên kết dưới dạng có thể click
      outputElement.innerHTML = `
        <p>Danh sách liên kết tải:</p>
        <ul>
          ${links.map((link) => `<li><a href="${link}" target="_blank" rel="noopener noreferrer">${link}</a></li>`).join('')}
        </ul>
      `;
    } catch (err) {
      // Hiển thị lỗi chi tiết
      outputElement.innerHTML = `Lỗi khi xử lý: ${err.message}`;
      console.error(err);
    }
  });
</script>






</section>