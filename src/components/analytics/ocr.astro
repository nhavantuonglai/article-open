---
import Analytics from '~/components/widgets/analytics.astro';
---

<Analytics

	id="ocr"
	title="Công cụ chuyển đổi hình ảnh chứa văn bản trực tuyến"
	description="Hướng dẫn: Chọn, tải lên tệp hình ảnh hoặc pdf, công cụ sẽ sử dụng AI để quét văn bản nhanh chóng và miễn phí."

	inputType="file"
	outputType="text"

	placeholder="Vui lòng nhập tệp cần chuyển đổi hình ảnh chứa văn bản trực tuyến ở đây."
	debounceTime={1000}

/>

<script client:load>

	document.addEventListener('DOMContentLoaded', () => {
		const analytics = document.querySelector('#ocr-processor');
		const apiKey = 'null';
		let debounceTimeout;

		analytics.addEventListener('fileChange', async (event) => {
			const file = event.detail;
			if (!file) return;

			const validTypes = ['image/jpeg', 'image/png', 'application/pdf'];
			if (!validTypes.includes(file.type)) {
				analytics.setError('Vui lòng chọn tệp PNG, JPG hoặc PDF.');
				return;
			}
			analytics.clearOutput();
		});

		analytics.addEventListener('submit', async (event) => {
			clearTimeout(debounceTimeout);
			debounceTimeout = setTimeout(async () => {
				const { file } = event.detail;
				
				if (!file) {
					analytics.setError('Vui lòng chọn tệp để xử lý.');
					return;
				}

				try {
					analytics.setProcessing(true);

					const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;

					const requestBody = {
						contents: [
							{
								parts: [
									{ text: 'Phân tích nội dung từ hình ảnh hoặc PDF.' }
								]
							}
						]
					};

					const response = await fetch(apiUrl, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify(requestBody)
					});

					const data = await response.json();

					if (!response.ok) {
						throw new Error(data.error?.message || 'Lỗi xử lý OCR');
					}

					if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
						const extractedText = data.candidates[0].content.parts[0].text;
						analytics.setOutput(extractedText);
						analytics.setSuccess(true);
					} else {
						analytics.setOutput('Không tìm thấy văn bản trong tệp.');
					}

				} catch (error) {
					console.error('Error:', error);
					const errorMessage = error.message.includes('API key')
						? 'Lỗi xác thực API. Vui lòng thử lại sau.'
						: `Lỗi: ${error.message}`;
					analytics.setError(errorMessage);
				} finally {
					analytics.setProcessing(false);
				}
			}, 500);
		});

		analytics.addEventListener('copy', () => {
			const outputText = analytics.getOutput();
			if (!outputText) return;

			navigator.clipboard.writeText(outputText)
				.then(() => {
					analytics.showCopySuccess();
				})
				.catch(error => {
					console.error('Lỗi sao chép:', error);
					analytics.setError('Không thể sao chép văn bản.');
				});
		});
	});

</script>