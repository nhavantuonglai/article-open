---
import Analytics from '~/components/widgets/analytics.astro';
---

<Analytics
	id="tiktok-downloader"
	title="Tải video TikTok không có hình mờ"
	description="Nhập URL video TikTok và nhận liên kết tải xuống không có hình mờ."
	inputType="text"
	outputType="file"
	placeholder="Nhập URL video TikTok tại đây."
	debounceTime={500}
/>

<script client:load>
document.getElementById('download-btn').addEventListener('click', async () => {
    const input = document.querySelector('input');
    const videoUrl = input ? input.value.trim() : '';

    if (!videoUrl) {
        alert('Vui lòng nhập URL video TikTok!');
        return;
    }

    const apiUrl = `https://tiktok-download-without-watermark.p.rapidapi.com/analysis?url=${encodeURIComponent(videoUrl)}&hd=0`;
    const options = {
        method: 'GET',
        headers: {
            'x-rapidapi-key': '2c07bec7c1msh0e50bac2d88eaa9p12658ejsn41d4a7d01b08',
            'x-rapidapi-host': 'tiktok-download-without-watermark.p.rapidapi.com'
        }
    };

    try {
        const response = await fetch(apiUrl, options);
        const result = await response.json();

        if (result && result.video && result.video.no_watermark) {
            const videoLink = result.video.no_watermark;
            
            const videoElement = document.getElementById('video-preview');
            videoElement.src = videoLink;
            videoElement.style.display = 'block';

            const downloadBtn = document.getElementById('download-btn');
            downloadBtn.innerHTML = `<a href="${videoLink}" download class="btn">Tải video</a>`;
        } else {
            alert('Không thể lấy video, vui lòng thử lại.');
        }
    } catch (error) {
        console.error('Lỗi:', error);
        alert('Đã xảy ra lỗi khi tải video.');
    }
});
</script>