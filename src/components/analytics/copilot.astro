---
import Button from '~/components/ui/button.astro';
import CTA from '~/components/widgets/services.astro';
---

<section class="relative md:-mt-[76px] not-prose">
	<div class="absolute inset-0 pointer-events-none" aria-hidden="true"></div>
	<div class="pt-0 md:pt-[120px] pointer-events-none"></div>
	<h1 class="mx-auto max-w-7xl md:px-6 leading-tighter text-center text-4xl md:text-5xl font-bold leading-tighter tracking-tighter mb-6 font-heading">
		Chat AI Cá Nhân
	</h1>
	<div class="mx-auto max-w-7xl md:px-6 px-4">
		<textarea id="input" placeholder="Nhập câu hỏi của bạn…" class="px-4 mb-6 py-6 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900" required></textarea>
		<button id="convert-btn" class="btn-primary w-auto mb-6">Gửi</button>
		<div id="output" class="mb-6 text-lg border border-gray-300 p-4 rounded-lg"></div>
	</div>

	<script client:load>
		document.addEventListener("DOMContentLoaded", function () {
			const buttonConvert = document.getElementById('convert-btn');
			const input = document.getElementById('input');
			const output = document.getElementById('output');

			buttonConvert.addEventListener('click', async function () {
				const inputText = input.value.trim();
				if (!inputText) {
					output.innerText = "Vui lòng nhập nội dung.";
					return;
				}

				const apiKey = API_KEY;
				const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

				output.innerText = "Đang xử lý…";

				try {
					const response = await fetch(endpoint, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							contents: [
								{
									parts: [
										{ text: inputText }
									]
								}
							]
						})
					});

					if (!response.ok) {
						output.innerText = `Lỗi từ máy chủ.`;
						console.error('Error response:', response.status, await response.text());
						return;
					}

					const result = await response.json();
					let aiResponseText = ""; // Khởi tạo biến để lưu trữ văn bản

					if (result.candidates && result.candidates.length > 0 && result.candidates[0].content) {
                        const aiResponse = result.candidates[0].content;
						if (typeof aiResponse === 'object' && aiResponse.parts && Array.isArray(aiResponse.parts) && aiResponse.parts.length > 0 && aiResponse.parts[0].text) {
                            aiResponseText = aiResponse.parts[0].text;
						} else if (typeof aiResponse === 'string') {
                            aiResponseText = aiResponse;
						} else {
							console.error("Unexpected response format:", aiResponse);
							aiResponseText = "Định dạng phản hồi không được hỗ trợ.";
						}
					} else {
						aiResponseText = "Định dạng phản hồi không được hỗ trợ.";
						console.error("Unexpected response structure:", result);
                    }

                    // Format the output text
                    aiResponseText = aiResponseText.replace(/—|[*-]/g, '–'); // Replace —, *, - with –
                    aiResponseText = aiResponseText.replace(/\.{3}/g, '…'); // Replace ... with …
                    aiResponseText = aiResponseText.trim();

					output.innerText = aiResponseText; // Set formatted text to output



				} catch (error) {
					console.error('Error:', error);
					output.innerText = 'Lỗi kết nối với máy chủ.';
				}
			});
		});
	</script>
</section>